<!doctype html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css" />
    <link rel="stylesheet" href="../static/css/base.css">
    <link rel="stylesheet" href="../static/css/question.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+And+White+Picture&display=swap" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <title>ÏßàÎ¨∏</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#like-button').click(function () {
                let questionId = $(this).data('question-id');
                $.ajax({
                    url: "{{ url_for('increment_like') }}",
                    type: "POST",
                    data: { question_id: questionId },
                    success: function (response) {
                        if (response.like_count !== undefined) {
                            $('#like-count').text(response.like_count);
                            if (response.action === "liked") {
                                $('#like-button').addClass('liked');
                            } else {
                                $('#like-button').removeClass('liked');
                            }
                        }
                    },
                    error: function (error) {
                        console.log("Error:", error);
                    }
                });
            });

            $('.question').click(function () {
                let questionId = $(this).data('question-id');
                let checkValue = $(this).data('check');  // Î≤ÑÌäºÏùò Ï≤¥ÌÅ¨ Í∞í Í∞ÄÏ†∏Ïò§Í∏∞

                $.ajax({
                    url: "{{ url_for('increment_click') }}",
                    type: "POST",
                    data: { question_id: questionId, check: checkValue },  // Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°
                    success: function (response) {
                        if (response.participant_count !== undefined) {
                            location.reload();  // ÏÉàÎ°úÍ≥†Ïπ®
                        }
                        console.log(response.msg); // ÏùëÎãµ Î©îÏãúÏßÄ Ï∂úÎ†•
                    },
                    error: function (error) {
                        console.log("Error:", error);
                    }
                });
            });
        });

        function question1() {
            let url = window.location.pathname;
            let question_id = url.split('/').pop();
            $.ajax({
                url: `/api/question/${question_id}/click`,
                type: "POST",
                data: {
                    "questionNum": 1
                },
                success: function (response) {
                    if (response['result'] == 'success') {
                        console.log(response['msg']);
                        $('.question-box').empty();
                        let temp_html = `
                            <div class="button-box question-select">
                                <button onclick="question1()" class="button question" data-question-id="{{ question['_id'] }}" data-check="1">{{ question['question1'] }}</button>
                            </div>
                            <div class="versus">
                                <span class="versus-v">V</span>
                                <span class="versus-s">S</span>
                            </div>
                            <div class="button-box">
                                <button onclick="question2()" class="button question" data-question-id="{{ question['_id'] }}" data-check="2">{{ question['question2'] }}</button>
                            </div>
                        `
                        $('.question-box').append(temp_html);
                    }
                },
                error: function (error) {
                    console.log("Error:", error);
                }
            });
        }

        function question2() {
            let url = window.location.pathname;
            let question_id = url.split('/').pop();
            $.ajax({
                url: `/api/question/${question_id}/click`,
                type: "POST",
                data: {
                    "questionNum": 2
                },
                success: function (response) {
                    if (response['result'] == 'success') {
                        console.log(response['msg']);
                        $('.question-box').empty();
                        let temp_html = `
                            <div class="button-box">
                                <button onclick="question1()" class="button question" data-question-id="{{ question['_id'] }}" data-check="1">{{ question['question1'] }}</button>
                            </div>
                            <div class="versus">
                                <span class="versus-v">V</span>
                                <span class="versus-s">S</span>
                            </div>
                            <div class="button-box question-select">
                                <button onclick="question2()" class="button question" data-question-id="{{ question['_id'] }}" data-check="2">{{ question['question2'] }}</button>
                            </div>
                        `
                        $('.question-box').append(temp_html);
                    }
                },
                error: function (error) {
                    console.log("Error:", error);
                }
            });
        }

        function question_refresh() {
            $('.question-box').empty();
            let temp_html = `
                <div class="button-box question-select">
                <div class="button-box">
                    <button onclick="question1()" class="button question" data-question-id="{{ question['_id'] }}" data-check="1">{{ question['question1'] }}</button>
                </div>
                <div class="versus">
                    <span class="versus-v">V</span>
                    <span class="versus-s">S</span>
                </div>
                <div class="button-box question-select">
                <div class="button-box">
                    <button onclick="question2()" class="button question" data-question-id="{{ question['_id'] }}" data-check="2">{{ question['question2'] }}</button>
                </div>
            `
            $('.question-box').append(temp_html);
        }
    </script>
</head>

<body>
    <header>
        <nav id="top-nav" role="navigation" class="is-white">
            <div class="nav-logo">
                <a class="navbar-item" href="/">
                    <img src="{{ url_for('static', filename='image/kaist_sw-logo.png') }}">
                </a>
            </div>
            <div class="nav-main">
                <div class="field is-grouped">
                    {% if session.get('token') %}
                    <form action="{{ url_for('logout') }}" method="post" style="margin-right: 10px;">
                        <button class="button">Î°úÍ∑∏ÏïÑÏõÉ</button>
                    </form>
                    <a class="button" href="{{ url_for('mypage') }}">ÎßàÏù¥ ÌéòÏù¥ÏßÄ</a>
                    {% else %}
                    <a class="button" href="{{ url_for('login') }}">Î°úÍ∑∏Ïù∏</a>
                    {% endif %}
                </div>
            </div>
        </nav>

        <section class="hero is-success">
            <div class="hero-body center">
                <p class="title">Ï†ïÍ∏Ä Î∞∏Îü∞Ïä§ Í≤åÏûÑ</p>
                <p class="subtitle is-6">ÎÇòÎßåÏùò Ï†ïÍ∏Ä Î¶¨Ï∂îÏñº ÎßåÎì§Í∏∞</p>
            </div>
        </section>
    </header>

    <section class="question-info">
        <div class="question-maker-info">
            <span class="tag is-link is-light">{{ member['nickname'] }}</span>
            <span class="created-at">{{ question['created_at'] }}</span>
        </div>
        <div class="question-indicator">
            <button id="like-button" class="like-button" style="border: none; background: none; cursor: pointer;"
                data-question-id="{{ question['_id'] }}">
                üëç<span id="like-count">{{ like_count }}</span>
            </button>
            <span>üí¨<span id="comment-count">{{ comments|length }}</span></span>
            <span>üñ±Ô∏è<span id="click-count">{{ click_count }}</span></span>
        </div>
    </section>
    <section class="question-box lr-align">
        {% if check['check'] == '1' %}
        <div class="button-box question-select">
            {% else %}
            <div class="button-box">
                {% endif %}
                <button onclick="question1()" class="button question" data-question-id="{{ question['_id'] }}" data-check="1">{{ question['question1'] }}</button>
            </div>
            <div class="versus">
                <span class="versus-v">V</span>
                <span class="versus-s">S</span>
            </div>
            {% if check['check'] == '2' %}
            <div class="button-box question-select">
                {% else %}
                <div class="button-box">
                    {% endif %}
                    <button onclick="question2()" class="button question" data-question-id="{{ question['_id'] }}" data-check="2">{{ question['question2'] }}</button>
                </div>
    </section>

    <!-- ÎåìÍ∏Ä Í∞úÏàòÎ•º ÌëúÏãúÌïòÎäî Î∂ÄÎ∂Ñ -->
    <section class="comments-section">
        <div class="comments-header">
            <span>ÎåìÍ∏Ä {{ comments|length }}Í∞ú</span>
        </div>
    </section>

    <section class="comment-input">
        <form action="{{ url_for('add_comment') }}" method="post">
            <textarea class="textarea is-success" rows="3" name="comment" placeholder="ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî"></textarea>
            <div class="button-right-align">
                <button class="button is-success is-light" type="submit">ÎåìÍ∏Ä Îì±Î°ù</button>
            </div>
        </form>
    </section>
    <section>
        {% for comment in comments %}
        <div class="comment-box">
            <div class="comment-nickname">
                <span class="tag is-link is-light">{{ comment.nickname }}</span>
                <p class="created-at">{{ comment.created_at }}</p>
            </div>
            <div class="comment-text">
                <p>{{ comment.text }}</p>
            </div>
        </div>
        {% endfor %}
    </section>
</body>

</html>